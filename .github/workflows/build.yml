name: 自动编译发布 InputSyncHelper

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. 安装依赖库
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp pynput pyautogui pyperclip qrcode pillow pyinstaller pystray

      - name: 4. 使用 PyInstaller 打包单文件
        run: |
          pyinstaller --noconsole --onefile --clean --icon=logo.ico --name "InputSyncHelper" main.py

      - name: 5. 制作便携版压缩包 (.zip)
        shell: pwsh
        run: |
          Compress-Archive -Path dist/InputSyncHelper.exe -DestinationPath dist/InputSyncHelper_Portable.zip

      - name: 6. 制作安装包 (使用 Inno Setup)
        # Windows-latest 镜像自带 ISCC 命令
        run: |
          # 现场生成一个简单的 Inno Setup 脚本
          echo '[Setup]' > setup.iss
          echo 'AppName=InputSyncHelper' >> setup.iss
          echo 'AppVersion=${{ github.ref_name }}' >> setup.iss
          echo 'DefaultDirName={autopf}\InputSyncHelper' >> setup.iss
          echo 'DefaultGroupName=InputSyncHelper' >> setup.iss
          echo 'UninstallDisplayIcon={app}\InputSyncHelper.exe' >> setup.iss
          echo 'Compression=lzma2' >> setup.iss
          echo 'SolidCompression=yes' >> setup.iss
          echo 'OutputDir=dist' >> setup.iss
          echo 'OutputBaseFilename=InputSyncHelper_Setup' >> setup.iss
          echo '[Files]' >> setup.iss
          echo 'Source: "dist\InputSyncHelper.exe"; DestDir: "{app}"; Flags: ignoreversion' >> setup.iss
          echo '[Icons]' >> setup.iss
          echo 'Name: "{group}\InputSyncHelper"; Filename: "{app}\InputSyncHelper.exe"' >> setup.iss
          echo 'Name: "{commondesktop}\InputSyncHelper"; Filename: "{app}\InputSyncHelper.exe"' >> setup.iss
          
          # 执行编译安装包
          iscc setup.iss

      - name: 7. 发布 Release 并上传所有格式
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/InputSyncHelper_Portable.zip
            dist/InputSyncHelper_Setup.exe
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}